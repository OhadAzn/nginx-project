# Two server blocks: port 8080 (HTML with rate limit), port 8081 (error)
# Rate limit: 5 requests/second per IP

events {}

http {
    access_log /dev/stdout;
    error_log /dev/stderr;

    # Rate limiting zone: 5 requests per second per IP
    # $binary_remote_addr = client IP (binary format, saves memory)
    # zone=limit:10m = 10MB shared memory for tracking IPs
    # rate=5r/s = 5 requests per second allowed
    limit_req_zone $binary_remote_addr zone=limit:10m rate=5r/s;

    server {
        listen 8080;

        location / {
            # Apply rate limit, allow small burst of 10 requests
            # nodelay = reject excess requests immediately (don't queue)
            limit_req zone=limit burst=10 nodelay;

            # Return 429 Too Many Requests when limit exceeded
            limit_req_status 429;

            root /var/www/html;
        }
    }

    server {
        listen 8081;
        location / {
            return 418 "I'm a teapot\n";
        }
    }
}
